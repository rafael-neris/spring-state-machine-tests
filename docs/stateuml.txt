@startuml
state COMPLETE_REFUND_FLOW <<join>>
state REFUND_FLOW <<fork>>
[*] --> NEW : PRE_AUTHORIZE
NEW --> PRE_AUTH : PRE_AUTH_APPROVED
NEW --> PRE_AUTH_ERROR : PRE_AUTH_DECLINED
PRE_AUTH_ERROR --> [*]
PRE_AUTH --> AUTHORIZED : AUTHORIZED
AUTHORIZED --> [*]
PRE_AUTH --> AUTHORIZE_ERROR : AUTH_DECLINED
AUTHORIZE_ERROR --> REFUND_FLOW : REFUND_FLOW
REFUND_FLOW --> Refund : REFUND
REFUND_FLOW --> Notify : NOTIFY
Refund --> COMPLETE_REFUND_FLOW
Notify --> COMPLETE_REFUND_FLOW
COMPLETE_REFUND_FLOW --> [*]


state Refund {
  [*] --> REFUND
  REFUND --> RESERVED : RESERVE
  RESERVED --> CONFIRMED : CONFIRM
  CONFIRMED --> REFUND_COMPLETED : REFUND_COMPLETED
  REFUND_COMPLETED --> [*]
}

state Notify {
  [*] --> WAITING_NOTIFY : START_NOTIFY
  WAITING_NOTIFY --> Notified : CONFIRM_NOTIFY
  Notified --> [*]
}
@enduml