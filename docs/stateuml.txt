@startuml
state COMPLETE_REFUND_FLOW <<join>>
state REFUND_FLOW <<fork>>
[*] --> NEW
NEW --> AUTHORIZED : AUTHORIZE
AUTHORIZED --> [*]
NEW --> AUTHORIZE_ERROR : AUTH_DECLINED
AUTHORIZE_ERROR --> REFUND_FLOW : REFUND_FLOW
REFUND_FLOW --> Refund : REFUND
REFUND_FLOW --> Notify : NOTIFY
Refund --> COMPLETE_REFUND_FLOW
Notify --> COMPLETE_REFUND_FLOW
COMPLETE_REFUND_FLOW --> REFUND_COMPLETED
REFUND_COMPLETED --> [*]


state Refund {
  [*] --> REFUND
  REFUND --> RESERVED : RESERVE
  RESERVED --> CONFIRMED : CONFIRM
  CONFIRMED --> [*] : REFUND_COMPLETED
}

state Notify {
  [*] --> WAITING_NOTIFY : START_NOTIFY
  WAITING_NOTIFY --> NOTIFIED : CONFIRM_NOTIFY
  NOTIFIED --> [*]
}
@enduml